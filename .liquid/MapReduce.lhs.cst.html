<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<title>MapReduce.lhs</title>
</head>
<head>
<link type='text/css' rel='stylesheet' href='liquid.css' />
</head>

<body>
<hr>
Put mouse over identifiers to see inferred types
Map-Reduce
==========

\begin{code}
<pre><span class=hs-linenum>5: </span><span class='hs-keyword'>module</span> <span class='hs-conid'>MapReduce</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapReduce</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<span class=hs-linenum>6: </span>
<span class=hs-linenum>7: </span><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<span class=hs-linenum>8: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>List</span>
<span class=hs-linenum>9: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span><span class='hs-layout'>,</span> <span class='hs-varid'>reduce</span><span class='hs-layout'>,</span> <span class='hs-varid'>concat</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldr</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldr1</span><span class='hs-layout'>)</span>
<span class=hs-linenum>10: </span><span class='hs-definition'>expand</span>   <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<span class=hs-linenum>11: </span><span class='hs-definition'>group</span>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>List</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<span class=hs-linenum>12: </span><span class='hs-definition'>collapse</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>List</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span>
</pre>\end{code}

The following is a super simplified implementation of
[Map-Reduce](http://en.wikipedia.org/wiki/MapReduce)
using the [Lists](List.lhs) and `Data.Map`.

\begin{code}
<pre><span class=hs-linenum>20: </span><span class='hs-definition'>mapReduce</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<span class=hs-linenum>21: </span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<span class=hs-linenum>22: </span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-varid'>a</span>
<span class=hs-linenum>23: </span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span>
<span class=hs-linenum>24: </span>
<span class=hs-linenum>25: </span><a class=annot href="#"><span class=annottext>(GHC.Classes.Ord k) =&gt;
lq_tmp$x##1064:(lq_tmp$x##1060:a -&gt; (List.List (k, v))) -&gt; lq_tmp$x##1065:(lq_tmp$x##1061:v -&gt; lq_tmp$x##1062:v -&gt; v) -&gt; lq_tmp$x##1066:(List.List a) -&gt; (Data.Map.Base.Map k v)</span><span class='hs-definition'>mapReduce</span></a> <a class=annot href="#"><span class=annottext>lq_tmp$x##1060:a -&gt; (List.List (k, v))</span><span class='hs-varid'>fm</span></a> <a class=annot href="#"><span class=annottext>lq_tmp$x##1061:v -&gt; lq_tmp$x##1062:v -&gt; v</span><span class='hs-varid'>fr</span></a> <a class=annot href="#"><span class=annottext>(List.List a)</span><span class='hs-varid'>xs</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kvm</span>
<span class=hs-linenum>26: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>27: </span>    <a class=annot href="#"><span class=annottext>(List.List ({VV##1087 : k^"lq_tmp$x##1089" | $k_$35$$35$1088[lq_tmp$36$x$35$$35$1083:=xs$35$$35$a1K4][lq_tmp$36$x$35$$35$1082:=fm$35$$35$a1K2]}, {VV##1090 : v^"lq_tmp$x##1092" | $k_$35$$35$1091[lq_tmp$36$x$35$$35$1083:=xs$35$$35$a1K4][lq_tmp$36$x$35$$35$1082:=fm$35$$35$a1K2]}))</span><span class='hs-varid'>kvs</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>lq_tmp$x##1083:(List.List {VV##1084 : a^"lq_tmp$x##1086" | $k_$35$$35$1085[lq_tmp$36$x$35$$35$1082:=fm$35$$35$a1K2]}) -&gt; (List.List ({VV##1087 : k^"lq_tmp$x##1089" | $k_$35$$35$1088[lq_tmp$36$x$35$$35$1082:=fm$35$$35$a1K2]}, {VV##1090 : v^"lq_tmp$x##1092" | $k_$35$$35$1091[lq_tmp$36$x$35$$35$1082:=fm$35$$35$a1K2]}))</span><span class='hs-varid'>expand</span></a>      <a class=annot href="#"><span class=annottext>{lq_tmp$x##1096 : lq_tmp$x##1097:a -&gt; (List.List (k, v)) | lq_tmp$x##1096 == fm##a1K2}</span><span class='hs-varid'>fm</span></a> <span class='hs-varid'>xs</span>     <span class='hs-comment'>-- step 1</span>
<span class=hs-linenum>28: </span>    <a class=annot href="#"><span class=annottext>(Data.Map.Base.Map {VV##1110 : k^"lq_tmp$x##1112" | $k_$35$$35$1111[lq_tmp$36$x$35$$35$1108:=fix$36$$36$dOrd_a1MY][lq_tmp$36$x$35$$35$1109:=kvs$35$$35$a1K5]} {lq_tmp$x##1104 : (List.List {VV##1113 : v^"lq_tmp$x##1115" | $k_$35$$35$1114[lq_tmp$36$x$35$$35$1108:=fix$36$$36$dOrd_a1MY][lq_tmp$36$x$35$$35$1109:=kvs$35$$35$a1K5]}) | size lq_tmp$x##1104 &gt; 0})</span><span class='hs-varid'>kvsm</span></a>  <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>lq_tmp$x##1109:(List.List ({VV##1110 : k^"lq_tmp$x##1112" | $k_$35$$35$1111[lq_tmp$36$x$35$$35$1108:=fix$36$$36$dOrd_a1MY]}, {VV##1113 : v^"lq_tmp$x##1115" | $k_$35$$35$1114[lq_tmp$36$x$35$$35$1108:=fix$36$$36$dOrd_a1MY]})) -&gt; (Data.Map.Base.Map {VV##1110 : k^"lq_tmp$x##1112" | $k_$35$$35$1111[lq_tmp$36$x$35$$35$1108:=fix$36$$36$dOrd_a1MY]} {lq_tmp$x##1104 : (List.List {VV##1113 : v^"lq_tmp$x##1115" | $k_$35$$35$1114[lq_tmp$36$x$35$$35$1108:=fix$36$$36$dOrd_a1MY]}) | size lq_tmp$x##1104 &gt; 0})</span><span class='hs-varid'>group</span></a>       <span class='hs-varid'>kvs</span>       <span class='hs-comment'>-- step 2</span>
<span class=hs-linenum>29: </span>    <a class=annot href="#"><span class=annottext>(Data.Map.Base.Map {VV##1135 : k^"lq_tmp$x##1137" | $k_$35$$35$1136[lq_tmp$36$x$35$$35$1130:=fr$35$$35$a1K3][lq_tmp$36$x$35$$35$1131:=kvsm$35$$35$a1K6]} {VV##1132 : v^"lq_tmp$x##1134" | $k_$35$$35$1133[lq_tmp$36$x$35$$35$1130:=fr$35$$35$a1K3][lq_tmp$36$x$35$$35$1131:=kvsm$35$$35$a1K6]})</span><span class='hs-varid'>kvm</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>lq_tmp$x##1131:(Data.Map.Base.Map {VV##1135 : k^"lq_tmp$x##1137" | $k_$35$$35$1136[lq_tmp$36$x$35$$35$1130:=fr$35$$35$a1K3]} {lq_tmp$x##1123 : (List.List {VV##1132 : v^"lq_tmp$x##1134" | $k_$35$$35$1133[lq_tmp$36$x$35$$35$1130:=fr$35$$35$a1K3]}) | size lq_tmp$x##1123 &gt; 0}) -&gt; (Data.Map.Base.Map {VV##1135 : k^"lq_tmp$x##1137" | $k_$35$$35$1136[lq_tmp$36$x$35$$35$1130:=fr$35$$35$a1K3]} {VV##1132 : v^"lq_tmp$x##1134" | $k_$35$$35$1133[lq_tmp$36$x$35$$35$1130:=fr$35$$35$a1K3]})</span><span class='hs-varid'>collapse</span></a> <a class=annot href="#"><span class=annottext>{lq_tmp$x##1139 : lq_tmp$x##1140:v -&gt; lq_tmp$x##1141:v -&gt; v | lq_tmp$x##1139 == fr##a1K3}</span><span class='hs-varid'>fr</span></a> <span class='hs-varid'>kvsm</span>      <span class='hs-comment'>-- step 3</span>
</pre>\end{code}

**The Problem** If you solved `foldr1` then you should
get a single type error below, in the call to `foldr1`
in `collapse`. Fix the error by **modifying the
refinement type specifications** only (do not modify any code).

**Note:** This problem requires you to have solved the
`foldr1` problem from [List.lhs](List.lhs); otherwise
no points.

Next, we briefly describe and show each step of the
`mapReduce` function.

Step 1: Map Elements into Key-Value Lists
-----------------------------------------

\begin{code}
<pre><span class=hs-linenum>48: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>expand</span>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>49: </span><a class=annot href="#"><span class=annottext>lq_tmp$x##994:(lq_tmp$x##993:a -&gt; (List.List (k, v))) -&gt; lq_tmp$x##995:(List.List a) -&gt; (List.List (k, v))</span><span class='hs-definition'>expand</span></a> <a class=annot href="#"><span class=annottext>lq_tmp$x##993:a -&gt; (List.List (k, v))</span><span class='hs-varid'>f</span></a> <a class=annot href="#"><span class=annottext>(List.List a)</span><span class='hs-varid'>xs</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>lq_tmp$x##1039:(List.List (List.List a)) -&gt; {lq_tmp$x##1037 : (List.List a) | size lq_tmp$x##1037 == sizeN lq_tmp$x##1039}</span><span class='hs-varid'>concat</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>lq_tmp$x##1005:(List.List {VV##1006 : a^"lq_tmp$x##1008" | $k_$35$$35$1007[lq_tmp$36$x$35$$35$1004:=f$35$$35$a1K8]}) -&gt; {lq_tmp$x##1000 : (List.List {lq_tmp$x##1027 : (List.List {lq_tmp$x##1026 : ({VV##1009 : k^"lq_tmp$x##1011" | $k_$35$$35$1010[VV$35$$35$1019:=lq_tmp$36$x$35$$35$1026][lq_tmp$36$x$35$$35$1004:=f$35$$35$a1K8][VV$35$$35$1022:=lq_tmp$36$x$35$$35$1027]}, {VV##1012 : v^"lq_tmp$x##1014" | $k_$35$$35$1013[VV$35$$35$1019:=lq_tmp$36$x$35$$35$1026][lq_tmp$36$x$35$$35$1004:=f$35$$35$a1K8][VV$35$$35$1022:=lq_tmp$36$x$35$$35$1027]})^"lq_tmp$x##1021" | $k_$35$$35$1020[VV$35$$35$1019:=lq_tmp$36$x$35$$35$1026][lq_tmp$36$x$35$$35$1004:=f$35$$35$a1K8][VV$35$$35$1022:=lq_tmp$36$x$35$$35$1027]})^"lq_tmp$x##1024" | $k_$35$$35$1023[lq_tmp$36$x$35$$35$1004:=f$35$$35$a1K8][VV$35$$35$1022:=lq_tmp$36$x$35$$35$1027]}) | size lq_tmp$x##1000 == size lq_tmp$x##1005}</span><span class='hs-varid'>map</span></a> <a class=annot href="#"><span class=annottext>{lq_tmp$x##1031 : lq_tmp$x##1032:a -&gt; (List.List (k, v)) | lq_tmp$x##1031 == f##a1K8}</span><span class='hs-varid'>f</span></a> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
</pre>\end{code}

Step 2: Group By Key
--------------------

\begin{code}
<pre><span class=hs-linenum>56: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>group</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>57: </span>                        <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-keyword'>{vs:</span><span class='hs-conid'>List</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>| size vs &gt; 0}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>58: </span>
<span class=hs-linenum>59: </span><a class=annot href="#"><span class=annottext>(GHC.Classes.Ord k) =&gt;
lq_tmp$x##905:(List.List (k, v)) -&gt; (Data.Map.Base.Map k {vs##5 : (List.List v) | size vs##5 &gt; 0})</span><span class='hs-definition'>group</span></a>     <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>lq_tmp$x##949:{lq_tmp$x##979 : (Data.Map.Base.Map {VV##966 : k^"lq_tmp$x##968" | $k_$35$$35$967[VV$35$$35$975:=lq_tmp$36$x$35$$35$979][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]} {lq_tmp$x##978 : (List.List {VV##969 : v^"lq_tmp$x##971" | $k_$35$$35$970[VV$35$$35$972:=lq_tmp$36$x$35$$35$978][VV$35$$35$975:=lq_tmp$36$x$35$$35$979][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]})^"lq_tmp$x##974" | $k_$35$$35$973[VV$35$$35$972:=lq_tmp$36$x$35$$35$978][VV$35$$35$975:=lq_tmp$36$x$35$$35$979][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]})^"lq_tmp$x##977" "lq_tmp$x##43" | $k_$35$$35$976[VV$35$$35$975:=lq_tmp$36$x$35$$35$979][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]} -&gt; lq_tmp$x##950:(List.List {lq_tmp$x##965 : ({VV##951 : k^"lq_tmp$x##953" | $k_$35$$35$952[VV$35$$35$961:=lq_tmp$36$x$35$$35$965][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]}, {VV##954 : v^"lq_tmp$x##956" | $k_$35$$35$955[VV$35$$35$961:=lq_tmp$36$x$35$$35$965][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]})^"lq_tmp$x##963" "lq_tmp$x##45" | $k_$35$$35$962[VV$35$$35$961:=lq_tmp$36$x$35$$35$965][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]}) -&gt; {lq_tmp$x##979 : (Data.Map.Base.Map {VV##966 : k^"lq_tmp$x##968" | $k_$35$$35$967[VV$35$$35$975:=lq_tmp$36$x$35$$35$979][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]} {lq_tmp$x##978 : (List.List {VV##969 : v^"lq_tmp$x##971" | $k_$35$$35$970[VV$35$$35$972:=lq_tmp$36$x$35$$35$978][VV$35$$35$975:=lq_tmp$36$x$35$$35$979][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]})^"lq_tmp$x##974" | $k_$35$$35$973[VV$35$$35$972:=lq_tmp$36$x$35$$35$978][VV$35$$35$975:=lq_tmp$36$x$35$$35$979][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]})^"lq_tmp$x##977" "lq_tmp$x##47" | $k_$35$$35$976[VV$35$$35$975:=lq_tmp$36$x$35$$35$979][lq_tmp$36$x$35$$35$948:=lq_anf$36$$35$$35$d1O0]}</span><span class='hs-varid'>foldr</span></a> <a class=annot href="#"><span class=annottext>lq_tmp$x##918:{lq_tmp$x##909 : ({VV##923 : k^"lq_tmp$x##925" "lq_tmp$x##781" | $k_$35$$35$924[lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF]
                                                                               &amp;&amp; $k_$35$$35$780[fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][VV$35$$35$789:=lq_tmp$36$x$35$$35$909][VV$35$$35$779:=VV$35$$35$923]}, {VV##920 : v^"lq_tmp$x##922" "lq_tmp$x##784" | $k_$35$$35$921[lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF]
                                                                                                                                                                                                                                                                                                                 &amp;&amp; $k_$35$$35$783[VV$35$$35$782:=VV$35$$35$920][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][VV$35$$35$789:=lq_tmp$36$x$35$$35$909]})^"lq_tmp$x##791" | $k_$35$$35$790[fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][VV$35$$35$789:=lq_tmp$36$x$35$$35$909]} -&gt; lq_tmp$x##919:{lq_tmp$x##911 : (Data.Map.Base.Map {VV##923 : k^"lq_tmp$x##925" "lq_tmp$x##795" | $k_$35$$35$924[lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           &amp;&amp; $k_$35$$35$794[VV$35$$35$802:=lq_tmp$36$x$35$$35$911][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][ds_d1NN:=lq_tmp$36$x$35$$35$918][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][VV$35$$35$793:=VV$35$$35$923]} {lq_tmp$x##910 : (List.List {VV##920 : v^"lq_tmp$x##922" "lq_tmp$x##798" | $k_$35$$35$921[lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         &amp;&amp; $k_$35$$35$797[VV$35$$35$802:=lq_tmp$36$x$35$$35$911][VV$35$$35$796:=VV$35$$35$920][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][ds_d1NN:=lq_tmp$36$x$35$$35$918][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][VV$35$$35$799:=lq_tmp$36$x$35$$35$910]})^"lq_tmp$x##801" | $k_$35$$35$800[VV$35$$35$802:=lq_tmp$36$x$35$$35$911][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][ds_d1NN:=lq_tmp$36$x$35$$35$918][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][VV$35$$35$799:=lq_tmp$36$x$35$$35$910]})^"lq_tmp$x##804" | $k_$35$$35$803[VV$35$$35$802:=lq_tmp$36$x$35$$35$911][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][ds_d1NN:=lq_tmp$36$x$35$$35$918][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF]} -&gt; {lq_tmp$x##913 : (Data.Map.Base.Map {VV##923 : k^"lq_tmp$x##925" "lq_tmp$x##808" | $k_$35$$35$924[lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          &amp;&amp; $k_$35$$35$807[VV$35$$35$815:=lq_tmp$36$x$35$$35$913][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][ds_d1NN:=lq_tmp$36$x$35$$35$918][VV$35$$35$806:=VV$35$$35$923][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][m$35$$35$a1Kc:=lq_tmp$36$x$35$$35$919]} {lq_tmp$x##912 : (List.List {VV##920 : v^"lq_tmp$x##922" "lq_tmp$x##811" | $k_$35$$35$921[lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               &amp;&amp; $k_$35$$35$810[VV$35$$35$815:=lq_tmp$36$x$35$$35$913][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][ds_d1NN:=lq_tmp$36$x$35$$35$918][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][m$35$$35$a1Kc:=lq_tmp$36$x$35$$35$919][VV$35$$35$812:=lq_tmp$36$x$35$$35$912][VV$35$$35$809:=VV$35$$35$920]})^"lq_tmp$x##814" | $k_$35$$35$813[VV$35$$35$815:=lq_tmp$36$x$35$$35$913][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][ds_d1NN:=lq_tmp$36$x$35$$35$918][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][m$35$$35$a1Kc:=lq_tmp$36$x$35$$35$919][VV$35$$35$812:=lq_tmp$36$x$35$$35$912]})^"lq_tmp$x##817" | $k_$35$$35$816[VV$35$$35$815:=lq_tmp$36$x$35$$35$913][fix$36$$36$dOrd_a1Mx:=fix$36$$36$dOrd_a1MF][ds_d1NN:=lq_tmp$36$x$35$$35$918][lq_tmp$36$x$35$$35$917:=fix$36$$36$dOrd_a1MF][m$35$$35$a1Kc:=lq_tmp$36$x$35$$35$919]}</span><span class='hs-varid'>addKV</span></a>  <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<span class=hs-linenum>60: </span>
<span class=hs-linenum>61: </span><a class=annot href="#"><span class=annottext>(GHC.Classes.Ord k) =&gt;
ds_d1NN:{VV##789 : ({VV##779 : k^"lq_tmp$x##781" | $k_$35$$35$780}, {VV##782 : t^"lq_tmp$x##784" | $k_$35$$35$783})^"lq_tmp$x##791" | $k_$35$$35$790} -&gt; m##a1Kc:{VV##802 : (Data.Map.Base.Map {VV##793 : k^"lq_tmp$x##795" | $k_$35$$35$794} {VV##799 : (List.List {VV##796 : t^"lq_tmp$x##798" | $k_$35$$35$797})^"lq_tmp$x##801" | $k_$35$$35$800})^"lq_tmp$x##804" | $k_$35$$35$803} -&gt; {VV##815 : (Data.Map.Base.Map {VV##806 : k^"lq_tmp$x##808" | $k_$35$$35$807} {VV##812 : (List.List {VV##809 : t^"lq_tmp$x##811" | $k_$35$$35$810})^"lq_tmp$x##814" | $k_$35$$35$813})^"lq_tmp$x##817" | $k_$35$$35$816}</span><span class='hs-definition'>addKV</span></a> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{VV##802 : (Data.Map.Base.Map {VV##793 : k^"lq_tmp$x##795" | $k_$35$$35$794} {VV##799 : (List.List {VV##796 : t^"lq_tmp$x##798" | $k_$35$$35$797})^"lq_tmp$x##801" | $k_$35$$35$800})^"lq_tmp$x##804" | $k_$35$$35$803}</span><span class='hs-varid'>m</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>lq_tmp$x##886:{VV##889 : k^"lq_tmp$x##891" "lq_tmp$x##68" | $k_$35$$35$890[lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]} -&gt; lq_tmp$x##887:{lq_tmp$x##898 : (List.List {VV##892 : t^"lq_tmp$x##894" | $k_$35$$35$893[VV$35$$35$895:=lq_tmp$36$x$35$$35$898][lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]})^"lq_tmp$x##897" "lq_tmp$x##70" | $k_$35$$35$896[VV$35$$35$895:=lq_tmp$36$x$35$$35$898][lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]} -&gt; lq_tmp$x##888:(Data.Map.Base.Map {VV##889 : k^"lq_tmp$x##891" "lq_tmp$x##72" | $k_$35$$35$890[lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]} {lq_tmp$x##898 : (List.List {VV##892 : t^"lq_tmp$x##894" | $k_$35$$35$893[VV$35$$35$895:=lq_tmp$36$x$35$$35$898][lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]})^"lq_tmp$x##897" "lq_tmp$x##73" | $k_$35$$35$896[VV$35$$35$895:=lq_tmp$36$x$35$$35$898][lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]}) -&gt; (Data.Map.Base.Map {VV##889 : k^"lq_tmp$x##891" "lq_tmp$x##75" | $k_$35$$35$890[lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]} {lq_tmp$x##898 : (List.List {VV##892 : t^"lq_tmp$x##894" | $k_$35$$35$893[VV$35$$35$895:=lq_tmp$36$x$35$$35$898][lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]})^"lq_tmp$x##897" "lq_tmp$x##76" | $k_$35$$35$896[VV$35$$35$895:=lq_tmp$36$x$35$$35$898][lq_tmp$36$x$35$$35$885:=fix$36$$36$dOrd_a1Mx]})</span><span class='hs-conid'>M</span></a><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>k</span> <span class='hs-varid'>vs'</span> <span class='hs-varid'>m</span>
<span class=hs-linenum>62: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>63: </span>    <a class=annot href="#"><span class=annottext>{lq_tmp$x##868 : (List.List {VV##873 : t^"lq_tmp$x##875" | $k_$35$$35$874[lq_tmp$36$x$35$$35$872:=lq_anf$36$$35$$35$d1NZ][lq_tmp$36$x$35$$35$871:=v$35$$35$a1Kb]}) | size lq_tmp$x##868 == 1 + size lq_anf$##d1NZ}</span><span class='hs-varid'>vs'</span></a>       <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>lq_tmp$x##872:(List.List {VV##873 : t^"lq_tmp$x##875" | $k_$35$$35$874[lq_tmp$36$x$35$$35$871:=v$35$$35$a1Kb]}) -&gt; {lq_tmp$x##868 : (List.List {VV##873 : t^"lq_tmp$x##875" | $k_$35$$35$874[lq_tmp$36$x$35$$35$871:=v$35$$35$a1Kb]}) | size lq_tmp$x##868 == 1 + size lq_tmp$x##872}</span><span class='hs-varid'>add</span></a> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>lq_tmp$x##849:{lq_tmp$x##858 : (List.List {VV##852 : t^"lq_tmp$x##854" | $k_$35$$35$853[lq_tmp$36$x$35$$35$848:=fix$36$$36$dOrd_a1Mx][VV$35$$35$855:=lq_tmp$36$x$35$$35$858]})^"lq_tmp$x##857" "lq_tmp$x##96" | $k_$35$$35$856[lq_tmp$36$x$35$$35$848:=fix$36$$36$dOrd_a1Mx][VV$35$$35$855:=lq_tmp$36$x$35$$35$858]} -&gt; lq_tmp$x##850:{VV##859 : k^"lq_tmp$x##861" "lq_tmp$x##98" | $k_$35$$35$860[lq_tmp$36$x$35$$35$848:=fix$36$$36$dOrd_a1Mx]} -&gt; lq_tmp$x##851:(Data.Map.Base.Map {VV##859 : k^"lq_tmp$x##861" "lq_tmp$x##100" | $k_$35$$35$860[lq_tmp$36$x$35$$35$848:=fix$36$$36$dOrd_a1Mx]} {lq_tmp$x##858 : (List.List {VV##852 : t^"lq_tmp$x##854" | $k_$35$$35$853[lq_tmp$36$x$35$$35$848:=fix$36$$36$dOrd_a1Mx][VV$35$$35$855:=lq_tmp$36$x$35$$35$858]})^"lq_tmp$x##857" "lq_tmp$x##101" | $k_$35$$35$856[lq_tmp$36$x$35$$35$848:=fix$36$$36$dOrd_a1Mx][VV$35$$35$855:=lq_tmp$36$x$35$$35$858]}) -&gt; {lq_tmp$x##858 : (List.List {VV##852 : t^"lq_tmp$x##854" | $k_$35$$35$853[lq_tmp$36$x$35$$35$848:=fix$36$$36$dOrd_a1Mx][VV$35$$35$855:=lq_tmp$36$x$35$$35$858]})^"lq_tmp$x##857" "lq_tmp$x##103" | $k_$35$$35$856[lq_tmp$36$x$35$$35$848:=fix$36$$36$dOrd_a1Mx][VV$35$$35$855:=lq_tmp$36$x$35$$35$858]}</span><span class='hs-conid'>M</span></a><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-varid'>empty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
</pre>\end{code}

Step 3: Reduce Each Key to Single Value
---------------------------------------

\begin{code}
<pre><span class=hs-linenum>70: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>collapse</span>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>71: </span>                  <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-keyword'>{vs:</span><span class='hs-conid'>List</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>| size vs &gt; 0}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>72: </span>                  <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>73: </span><a class=annot href="#"><span class=annottext>lq_tmp$x##733:(lq_tmp$x##731:v -&gt; lq_tmp$x##732:v -&gt; v) -&gt; lq_tmp$x##734:(Data.Map.Base.Map k {vs##10 : (List.List v) | size vs##10 &gt; 0}) -&gt; (Data.Map.Base.Map k v)</span><span class='hs-definition'>collapse</span></a> <a class=annot href="#"><span class=annottext>lq_tmp$x##731:v -&gt; lq_tmp$x##732:v -&gt; v</span><span class='hs-varid'>f</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>lq_tmp$x##759:(lq_tmp$x##758:a -&gt; b) -&gt; lq_tmp$x##760:(Data.Map.Base.Map k a) -&gt; (Data.Map.Base.Map k b)</span><span class='hs-conid'>M</span></a><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>lq_tmp$x##744:{lq_tmp$x##738 : (List.List {VV##745 : v^"lq_tmp$x##747" | $k_$35$$35$746[lq_tmp$36$x$35$$35$743:=f$35$$35$a1Ke]}) | size lq_tmp$x##738 &gt; 0} -&gt; {VV##745 : v^"lq_tmp$x##747" | $k_$35$$35$746[lq_tmp$36$x$35$$35$743:=f$35$$35$a1Ke]}</span><span class='hs-varid'>foldr1</span></a> <a class=annot href="#"><span class=annottext>{lq_tmp$x##749 : lq_tmp$x##750:v -&gt; lq_tmp$x##751:v -&gt; v | lq_tmp$x##749 == f##a1Ke}</span><span class='hs-varid'>f</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>74: </span>
<span class=hs-linenum>75: </span><span class='hs-definition'>toList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<span class=hs-linenum>76: </span><a class=annot href="#"><span class=annottext>lq_tmp$x##548:{VV##555 : (Data.Map.Base.Map {VV##549 : k^"lq_tmp$x##551" | $k_$35$$35$550} {VV##552 : v^"lq_tmp$x##554" | $k_$35$$35$553})^"lq_tmp$x##557" | $k_$35$$35$556} -&gt; {VV##571 : (List.List {VV##568 : ({VV##558 : k^"lq_tmp$x##560" | $k_$35$$35$559}, {VV##561 : v^"lq_tmp$x##563" | $k_$35$$35$562})^"lq_tmp$x##570" | $k_$35$$35$569})^"lq_tmp$x##573" | $k_$35$$35$572}</span><span class='hs-definition'>toList</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>k##a1Kf:{VV##574 : k^"lq_tmp$x##576" | $k_$35$$35$575} -&gt; v##a1Kg:{VV##578 : v^"lq_tmp$x##580" | $k_$35$$35$579} -&gt; acc##a1Kh:{VV##595 : (List.List {VV##592 : ({VV##582 : k^"lq_tmp$x##584" | $k_$35$$35$583}, {VV##585 : v^"lq_tmp$x##587" | $k_$35$$35$586})^"lq_tmp$x##594" | $k_$35$$35$593})^"lq_tmp$x##597" | $k_$35$$35$596} -&gt; {VV##612 : (List.List {VV##609 : ({VV##599 : k^"lq_tmp$x##601" | $k_$35$$35$600}, {VV##602 : v^"lq_tmp$x##604" | $k_$35$$35$603})^"lq_tmp$x##611" | $k_$35$$35$610})^"lq_tmp$x##614" | $k_$35$$35$613}</span><span class='hs-conid'>M</span></a><span class='hs-varop'>.</span><span class='hs-varid'>foldrWithKey</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV##574 : k^"lq_tmp$x##576" | $k_$35$$35$575}</span><span class='hs-varid'>k</span></a> <a class=annot href="#"><span class=annottext>{VV##578 : v^"lq_tmp$x##580" | $k_$35$$35$579}</span><span class='hs-varid'>v</span></a> <a class=annot href="#"><span class=annottext>{VV##595 : (List.List {VV##592 : ({VV##582 : k^"lq_tmp$x##584" | $k_$35$$35$583}, {VV##585 : v^"lq_tmp$x##587" | $k_$35$$35$586})^"lq_tmp$x##594" | $k_$35$$35$593})^"lq_tmp$x##597" | $k_$35$$35$596}</span><span class='hs-varid'>acc</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>{lq_tmp$x##616 : ({VV##621 : k^"lq_tmp$x##623" | $k_$35$$35$622[lq_tmp$36$x$35$$35$619:=k$35$$35$a1Kf][lq_tmp$36$x$35$$35$620:=v$35$$35$a1Kg]}, {VV##624 : v^"lq_tmp$x##626" | $k_$35$$35$625[lq_tmp$36$x$35$$35$619:=k$35$$35$a1Kf][lq_tmp$36$x$35$$35$620:=v$35$$35$a1Kg]}) | snd lq_tmp$x##616 == v##a1Kg
                                                                                                                                                                                                                                                                                &amp;&amp; fst lq_tmp$x##616 == k##a1Kf
                                                                                                                                                                                                                                                                                &amp;&amp; x_Tuple22 lq_tmp$x##616 == v##a1Kg
                                                                                                                                                                                                                                                                                &amp;&amp; x_Tuple21 lq_tmp$x##616 == k##a1Kf}</span><span class='hs-varid'>add</span></a> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>empty</span>
</pre>\end{code}

</body>
</html>